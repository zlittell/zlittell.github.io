---
title:  "Python script to edit serial numbers in hex files."
categories:
  - Scripting
tags:
  - python
  - production
  - automation
  - hex
  - serial number

author_profile: false
---
###### INTRODUCTION
Scripting is something that helps engineers of all types (software/data center/electrical/etc). It truly can be done in just about any language you are familiar with, but I do feel that some languages are better than others and interpreted languages feel like the best option. However, much like any other engineering task, the best language to use can really depend on what languages you are familiar with and what end result you want to achieve. For this task I just needed a script that I could access from bash and I feel like python is the perfect language for such a task. If I needed a GUI for production staff to utilize, I might go with a .NET language because my familiarity with Python based GUI apps is not great.

The goal of this project is to replace a 10 ascii byte serial with a string provided to the script or one that is autogenerated by incrementation. The final code for this project can be found over on my [GitHub][serialhexedit-codebase]

###### PREPARING MICROCONTROLLER CODE
In order to get this to work we reserve a location for our character array in the RAM of our microcontroller. The full example linker file is [here][macro9pad-linkerfile]. First we want to carve out the actual memory section in our memory list.
We use the datasheet to layout our memory section and it would look something like this:
```c
MEMORY
{
  rom      (rx)  : ORIGIN = 0x00000000, LENGTH = 0x00004000
  ram      (rwx) : ORIGIN = 0x20000000, LENGTH = 0x00001000
}
```
Then we want to carve off a few areas for specific purposes. Below we have carved out a future bootloader area, but currently set its length to 0. Next we have our normal ROM space from 0x0000 to 0x3EF4. Then we reserve 10 bytes (0xA) for the serial. Next I have an eeprom emulation area at 0x3F00 with a length of 0x0100. Finally we have our RAM section mapped. *NOTE* These sections do not use the full 0x4000 of ROM available and thats okay. I do not need it and I don't want to change it now that I have units in the wild with this code.
Here is what we end up with:
```
MEMORY
{
  boot     (r)   : ORIGIN = 0x00000000, LENGTH = 0x00000000
  rom      (rx)  : ORIGIN = 0x00000000, LENGTH = 0x00003EF4
  serial   (rw)  : ORIGIN = 0x00003EF4, LENGTH = 0x0000000A
  eep	   (rw)	 : ORIGIN = 0x00003F00, LENGTH = 0x00000100
  ram      (rwx) : ORIGIN = 0x20000000, LENGTH = 0x00001000
}
```

The very next thing we need to do is tell the linker that we should keep this space free even if we don't use the variable in our code. We do this by creating a section in the linker file for the memory we carved away previously.
```
SECTIONS
{
	/* eeprom sim area */
	.eepromBlock :
	{
		KEEP(*(.deviceProfileSection))
	} > eep

    /* serial number section */
    .serialNumber :
    {
        KEEP(*(.serialNumberSection))
    } > serial

    .text :
    {
    ...
```
We tell the linker to keep the serialNumberSection even if not referenced by code and then tell the linker to put that into the "serial" MEMORY area. Now we have the section correctly reserved and if you compiled you should be able to see that. Next we should create an array of ascii characters at serialNumberSection to represent our serial number. For this I created the file, [serialnumber.c][m9p-serialnumberdotc] and put the following code into it:
```c
const char __attribute__ ((section (".serialNumberSection"))) DeviceSerialNumber[DEVICESERIALNUMBERLENGTH] = 
{
	"0123456789"
};
```
This simple bit of code creates a const char array DeviceSerialNumber of "0123456789" and stores it at the serialNumberSection we created previously.

With all of this done, when we compile we get this very interesting section towards the end of our hex file:
`:0A3EF40030313233343536373839B7`

@TODO START EXPLAINING HOW INTEL HEX LINES ARE CONSTRUCTED

###### BEGINNING SCRIPT

[serialhexedit-codebase]: https://github.com/zlittell/MSF.SerialHEXEdit
[macro9pad-linkerfile]: https://github.com/zlittell/Macro9PadFW/blob/master/src/startup/samd11d14am_flash.ld
[m9p-serialnumberdotc]: https://github.com/zlittell/Macro9PadFW/blob/master/src/serialnumber.c